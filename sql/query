-- Weekly (ISO calendar week / KW) inventory projection with TRUE stock floor (BigQuery)

WITH RECURSIVE

-- 1) SKU base
sku_base AS(
  SELECT 
    sd.sku_id,
    sd.unit_cost,
    sd.brand,
    sd.supplier,
    sd.category,
    asp.avg_selling_price_2025
  FROM `Inventory_Projection_Dashboard.sku_data` sd
  LEFT JOIN `Inventory_Projection_Dashboard.avg_selling_prices_2025` asp
    ON sd.sku_id = asp.sku_id
),

-- 2) 2025 sales â†’ daily velocity
sales_2025 AS (
  SELECT
    sku_id,
    SUM(units_sold) AS units_sold_2025
  FROM `Inventory_Projection_Dashboard.daily_sales_history_2022_2025`
  WHERE date >= '2025-01-01'
  GROUP BY sku_id
),

sales_velocity AS (
  SELECT
    s2.sku_id,
    SAFE_DIVIDE(units_sold_2025, 365) AS daily_sales_velocity,
    SAFE_DIVIDE(units_sold_2025, 365) * sb.unit_cost AS daily_cogs
  FROM sales_2025 s2
  LEFT JOIN sku_base sb
    ON s2.sku_id = sb.sku_id
),

-- 3) Initial stock snapshot (day 1)
initial_stock AS (
  SELECT
    sku_id,
    snapshot_date,
    available_qty
  FROM `Inventory_Projection_Dashboard.inventory_snapshot_2026_01_01`
),

-- 4) ISO calendar weeks (KW): week_start = Monday of ISO week
calendar_weeks AS (
  SELECT DISTINCT
    DATE_TRUNC(d, ISOWEEK) AS week_start
  FROM UNNEST(GENERATE_DATE_ARRAY(DATE '2026-01-01', DATE '2026-12-31')) AS d
),

-- 5) Orders aggregated by ISO week
orders_weekly AS (
  SELECT
    sku_id,
    DATE_TRUNC(expected_delivery_date, ISOWEEK) AS week_start,
    SUM(ordered_qty) AS ordered_qty_week
  FROM `Inventory_Projection_Dashboard.incoming_purchase_orders_2026`
  GROUP BY sku_id, week_start
),

-- 6) Cumulative revenue and ABC analysis
revenue_calculation AS (
  SELECT
    s2025.sku_id,
    s2025.units_sold_2025 * sb.avg_selling_price_2025 AS revenue,
    SUM(s2025.units_sold_2025 * sb.avg_selling_price_2025) OVER () AS total_revenue
  FROM sales_2025 s2025
  LEFT JOIN sku_base sb
    ON s2025.sku_id = sb.sku_id
),

cumulative_rev AS (
  SELECT
    sku_id,
    SAFE_DIVIDE(revenue, total_revenue) AS revenue_contribution,
    SUM(SAFE_DIVIDE(revenue, total_revenue)) OVER (
      ORDER BY revenue DESC
      ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
    ) AS cumulative_contribution
  FROM revenue_calculation
),

abc AS (
  SELECT
    sku_id,
    cumulative_contribution,
    CASE
      WHEN cumulative_contribution <= 0.4 THEN 'A'
      WHEN cumulative_contribution <= 0.8 THEN 'B'
      ELSE 'C'
    END AS class
  FROM cumulative_rev
),

-- 7) SKU Ã— ISO week inputs (small table: ~53 rows per SKU)
weekly_inputs AS (
  SELECT
    sb.sku_id,
    cw.week_start,
    ROW_NUMBER() OVER (
      PARTITION BY sb.sku_id
      ORDER BY cw.week_start
    ) AS rn,

    COALESCE(
      CASE
        WHEN DATE_TRUNC(ins.snapshot_date, ISOWEEK) = cw.week_start THEN ins.available_qty
        ELSE 0
      END,
      0
    ) AS initial_stock_week,

    COALESCE(ow.ordered_qty_week, 0) AS ordered_qty_week,
    COALESCE(sv.daily_sales_velocity, 0) * 7 AS demand_week,
    COALESCE(sv.daily_cogs, 0) * 7 AS cogs_week,

    EXTRACT(ISOYEAR FROM cw.week_start) AS iso_year,
    EXTRACT(ISOWEEK FROM cw.week_start) AS iso_week,
    FORMAT_DATE('%G-W%V', cw.week_start) AS iso_week_label
  FROM sku_base sb
  CROSS JOIN calendar_weeks cw
  LEFT JOIN initial_stock ins
    ON ins.sku_id = sb.sku_id
  LEFT JOIN orders_weekly ow
    ON ow.sku_id = sb.sku_id
   AND ow.week_start = cw.week_start
  LEFT JOIN sales_velocity sv
    ON sv.sku_id = sb.sku_id
),

-- 8) Recursive weekly projection (TRUE floor: never below 0)
weekly_projection AS (
  -- Anchor
  SELECT
    sku_id,
    week_start,
    rn,
    iso_year,
    iso_week,
    iso_week_label,
    initial_stock_week,
    ordered_qty_week,
    demand_week,
    GREATEST(0, initial_stock_week + ordered_qty_week - demand_week) AS inventory_projection
  FROM weekly_inputs
  WHERE rn = 1

  UNION ALL

  -- Recursive step
  SELECT
    wi.sku_id,
    wi.week_start,
    wi.rn,
    wi.iso_year,
    wi.iso_week,
    wi.iso_week_label,
    wi.initial_stock_week,
    wi.ordered_qty_week,
    wi.demand_week,
    GREATEST(
      0,
      wp.inventory_projection
      + wi.initial_stock_week
      + wi.ordered_qty_week
      - wi.demand_week
    ) AS inventory_projection
  FROM weekly_projection wp
  JOIN weekly_inputs wi
    ON wi.sku_id = wp.sku_id
   AND wi.rn = wp.rn + 1
),


stock_flag AS (
    SELECT 
    wp.sku_id,
    wp.week_start,
    CASE WHEN wp.inventory_projection > 0 THEN 1 ELSE 0 END AS stock_flag

    FROM weekly_projection wp),

reach_by_week AS (
  SELECT
    sf.sku_id,
    sf.week_start,
    sf.stock_flag,
    CASE WHEN(
    AVG(sf.stock_flag) OVER (
      PARTITION BY sf.sku_id
      ORDER BY sf.week_start
      ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
      ) ) < 1 THEN 0 ELSE 1 END AS weeks_reach
  FROM stock_flag sf),

stock_reach_projection AS(
  SELECT
    rb.sku_id,
    rb.week_start,
    rb.stock_flag,
    SUM(rb.weeks_reach) OVER (
      PARTITION BY rb.sku_id
      
    ) AS reach_projection_weeks

  FROM reach_by_week rb


)
  
  



SELECT 
  wp.sku_id,
  wp.week_start,
  sb.category,
  sb.supplier,
  sb.brand,
  wp.iso_year AS calendar_year,
  wp.iso_week_label AS calendar_week,
  abc.class AS class,
  ow.ordered_qty_week AS incoming_units,
  CAST(wp.inventory_projection AS INT64) AS inventory_projection,
  CAST(sb.unit_cost * wp.inventory_projection AS INT64) AS inventory_value,

  sr.reach_projection_weeks,

  CASE 
    WHEN sr.reach_projection_weeks <= 8 THEN 'ðŸ”´ Critical'
    WHEN sr.reach_projection_weeks <= 12 THEN 'ðŸŸ  At risk'
    WHEN sr.reach_projection_weeks <= 16 THEN 'ðŸŸ¡ Watch'
    ELSE 'ðŸŸ¢ No risk'END AS stockout_risk


,

  sr.stock_flag,
  --SERVICE LEVEL CALCULATION FOR DE NEXT 6 MONTHS / 24 WEEKS
  SUM(sr.stock_flag) OVER (
    PARTITION BY wp.sku_id
    ORDER BY wp.week_start
    ROWS BETWEEN 1 FOLLOWING AND 24 FOLLOWING
  )/24 AS projected_service_level,
  
  sv.daily_sales_velocity,


  CASE
    WHEN sv.daily_sales_velocity = 0 THEN 'Dead stock'
    WHEN sv.daily_sales_velocity <= 1 THEN 'Slow moving'
    WHEN sv.daily_sales_velocity <= 5 THEN 'Medium moving'
    ELSE 'Fast moving'
  END AS sales_velocity,

  

FROM weekly_projection wp
LEFT JOIN sku_base sb
  ON wp.sku_id = sb.sku_id
LEFT JOIN sales_velocity sv
  ON wp.sku_id = sv.sku_id
LEFT JOIN abc
  ON wp.sku_id = abc.sku_id
LEFT JOIN stock_reach_projection sr
  ON wp.sku_id = sr.sku_id 
  AND wp.week_start = sr.week_start
LEFT JOIN orders_weekly ow
  ON wp.sku_id = ow.sku_id 
  AND wp.week_start = ow.week_start
LEFT JOIN weekly_inputs wi
  ON wp.sku_id = wi.sku_id 
  AND wp.week_start = wi.week_start


-- IMPORTANT: join weekly_inputs at the same grain (sku_id + rn or week_start)


ORDER BY wp.sku_id, wp.week_start

;
